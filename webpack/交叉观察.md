# äº¤å‰è§‚å¯Ÿ API Intersection Observer

## ä»¥å‰
è¿‡å»ï¼Œè¦æ£€æµ‹ä¸€ä¸ªå…ƒç´ æ˜¯å¦å¯è§æˆ–è€…ä¸¤ä¸ªå…ƒç´ æ˜¯å¦ç›¸äº¤å¹¶ä¸å®¹æ˜“ï¼Œå¾ˆå¤šè§£å†³åŠæ³•ä¸å¯é æˆ–æ€§èƒ½å¾ˆå·®ã€‚ç„¶è€Œï¼Œéšç€äº’è”ç½‘çš„å‘å±•ï¼Œè¿™ç§éœ€æ±‚å´ä¸æ—¥ä¿±å¢ï¼Œæ¯”å¦‚ï¼Œä¸‹é¢è¿™äº›æƒ…å†µéƒ½éœ€è¦ç”¨åˆ°ç›¸äº¤æ£€æµ‹ï¼š

- å›¾ç‰‡æ‡’åŠ è½½â€”â€”å½“å›¾ç‰‡æ»šåŠ¨åˆ°å¯è§æ—¶æ‰è¿›è¡ŒåŠ è½½
- å†…å®¹æ— é™æ»šåŠ¨â€”â€”ä¹Ÿå°±æ˜¯ç”¨æˆ·æ»šåŠ¨åˆ°æ¥è¿‘å†…å®¹åº•éƒ¨æ—¶ç›´æ¥åŠ è½½æ›´å¤šï¼Œè€Œæ— éœ€ç”¨æˆ·æ“ä½œç¿»é¡µï¼Œç»™ç”¨æˆ·ä¸€ç§ç½‘é¡µå¯ä»¥æ— é™æ»šåŠ¨çš„é”™è§‰
- æ£€æµ‹å¹¿å‘Šçš„æ›å…‰æƒ…å†µâ€”â€”ä¸ºäº†è®¡ç®—å¹¿å‘Šæ”¶ç›Šï¼Œéœ€è¦çŸ¥é“å¹¿å‘Šå…ƒç´ çš„æ›å…‰æƒ…å†µï¼ˆåŸ‹ç‚¹ï¼‰
- åœ¨ç”¨æˆ·çœ‹è§æŸä¸ªåŒºåŸŸæ—¶æ‰§è¡Œä»»åŠ¡æˆ–æ’­æ”¾åŠ¨ç”»

è¿‡å»ï¼Œç›¸äº¤æ£€æµ‹é€šå¸¸è¦ç”¨åˆ°äº‹ä»¶ç›‘å¬ï¼Œå¹¶ä¸”éœ€è¦é¢‘ç¹è°ƒç”¨ Element.getBoundingClientRect() æ–¹æ³•ä»¥è·å–ç›¸å…³å…ƒç´ çš„è¾¹ç•Œä¿¡æ¯ã€‚äº‹ä»¶ç›‘å¬å’Œè°ƒç”¨ Element.getBoundingClientRect()  éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸Šè¿è¡Œï¼Œå› æ­¤é¢‘ç¹è§¦å‘ã€è°ƒç”¨å¯èƒ½ä¼šé€ æˆæ€§èƒ½é—®é¢˜ã€‚è¿™ç§æ£€æµ‹æ–¹æ³•æå…¶æ€ªå¼‚ä¸”ä¸ä¼˜é›…

## Intersection Observer API æ˜¯ä»€ä¹ˆ

æˆ‘ä»¬éœ€è¦è§‚å¯Ÿçš„å…ƒç´ è¢«ç§°ä¸º ç›®æ ‡å…ƒç´ (target)ï¼Œè®¾å¤‡è§†çª—æˆ–è€…å…¶ä»–æŒ‡å®šçš„å…ƒç´ è§†å£çš„è¾¹ç•Œæ¡†æˆ‘ä»¬ç§°å®ƒä¸º æ ¹å…ƒç´ (root)ï¼Œæˆ–è€…ç®€ç§°ä¸º æ ¹ ã€‚

Intersection Observer API ç¿»è¯‘è¿‡æ¥å«åš â€œ**äº¤å‰è§‚å¯Ÿå™¨**â€ï¼Œå› ä¸ºåˆ¤æ–­å…ƒç´ æ˜¯å¦å¯è§ï¼ˆé€šå¸¸æƒ…å†µä¸‹ï¼‰çš„æœ¬è´¨å°±æ˜¯åˆ¤æ–­ç›®æ ‡å…ƒç´ å’Œæ ¹å…ƒç´ æ˜¯ä¸æ˜¯äº§ç”Ÿäº† **äº¤å‰åŒºåŸŸ**ã€‚

ä¸ºä»€ä¹ˆæ˜¯é€šå¸¸æƒ…å†µä¸‹ï¼Œå› ä¸ºå½“æˆ‘ä»¬ css è®¾ç½®äº† opacity: 0ï¼Œvisibility: hidden æˆ–è€… ç”¨å…¶ä»–çš„å…ƒç´ è¦†ç›–ç›®æ ‡å…ƒç´  çš„æ—¶å€™ï¼Œå¯¹äºè§†å›¾æ¥è¯´æ˜¯ä¸å¯è§çš„ï¼Œä½†å¯¹äºäº¤å‰è§‚å¯Ÿå™¨æ¥è¯´æ˜¯å¯è§çš„ã€‚è¿™é‡Œå¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œå¤§å®¶åªéœ€è®°ä½ï¼Œäº¤å‰è§‚å¯Ÿå™¨åªå…³å¿ƒ **ç›®æ ‡å…ƒç´  å’Œ æ ¹å…ƒç´ ** æ˜¯å¦æœ‰ **äº¤å‰åŒºåŸŸ**ï¼Œ è€Œä¸ç®¡è§†è§‰ä¸Šèƒ½ä¸èƒ½çœ‹è§è¿™ä¸ªå…ƒç´ ã€‚å½“ç„¶å¦‚æœè®¾ç½®äº† displayï¼šnoneï¼Œé‚£ä¹ˆäº¤å‰è§‚å¯Ÿå™¨å°±ä¸ä¼šç”Ÿæ•ˆäº†ï¼Œå…¶å®ä¹Ÿå¾ˆå¥½ç†è§£ï¼Œå› ä¸ºå…ƒç´ å·²ç»ä¸å­˜åœ¨äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±ç›‘æµ‹ä¸åˆ°äº†ã€‚


> **ä¸€å¥è¯æ€»ç»“ï¼šIntersection Observer API æä¾›äº†ä¸€ç§å¼‚æ­¥æ£€æµ‹ç›®æ ‡å…ƒç´ ä¸ç¥–å…ˆå…ƒç´ æˆ– viewport ç›¸äº¤æƒ…å†µå˜åŒ–çš„æ–¹æ³•ã€‚ -- MDN**

## Intersection Observer APIæ€ä¹ˆç”¨
```
// è°ƒç”¨æ„é€ å‡½æ•° IntersectionObserver ç”Ÿæˆè§‚å¯Ÿå™¨
const myObserver = new IntersectionObserver(callback, options); 
```
é¦–å…ˆè°ƒç”¨æµè§ˆå™¨åŸç”Ÿæ„é€ å‡½æ•° IntersectionObserver ï¼Œæ„é€ å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª è§‚å¯Ÿå™¨å®ä¾‹ ã€‚

æ„é€ å‡½æ•° IntersectionObserver æ¥æ”¶ä¸¤ä¸ªå‚æ•° callback å’Œoptions 

ä¸ºäº†æ–¹ä¾¿ç†è§£ï¼Œæˆ‘ä»¬å…ˆçœ‹ç¬¬äºŒä¸ªå‚æ•° options ã€‚ä¸€ä¸ªå¯ä»¥ç”¨æ¥é…ç½®è§‚å¯Ÿå™¨å®ä¾‹çš„å¯¹è±¡ï¼Œé‚£ä¹ˆè¿™ä¸ªé…ç½®å¯¹è±¡éƒ½åŒ…å«å“ªäº›å±æ€§å‘¢ï¼Ÿ

### optionsï¼š é…ç½®å¯¹è±¡ï¼ˆå¯é€‰ï¼Œä¸ä¼ æ—¶ä¼šä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
æ„é€ å‡½æ•°æ¥æ”¶çš„å‚æ•° options


- rootï¼š è®¾ç½®ç›®æ ‡å…ƒç´ çš„æ ¹å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ç”¨æ¥åˆ¤æ–­å…ƒç´ æ˜¯å¦å¯è§çš„åŒºåŸŸï¼Œå¿…é¡»æ˜¯ç›®æ ‡å…ƒç´ çš„çˆ¶çº§å…ƒç´ ï¼Œå¦‚æœä¸æŒ‡å®šçš„è¯ï¼Œåˆ™ä½¿ç”¨æµè§ˆå™¨è§†çª—ï¼Œä¹Ÿå°±æ˜¯ documentã€‚

- rootMarginï¼š ä¸€ä¸ªåœ¨è®¡ç®—äº¤å‰å€¼æ—¶æ·»åŠ è‡³æ ¹çš„è¾¹ç•Œä¸­çš„ä¸€ç»„åç§»é‡ï¼Œç±»å‹ä¸ºå­—ç¬¦ä¸² (string)  ï¼Œå¯ä»¥æœ‰æ•ˆçš„ç¼©å°æˆ–æ‰©å¤§æ ¹çš„åˆ¤å®šèŒƒå›´ä»è€Œæ»¡è¶³è®¡ç®—éœ€è¦ã€‚è¯­æ³•å¤§è‡´å’ŒCSS ä¸­ margin å±æ€§ç­‰åŒï¼Œé»˜è®¤å€¼ â€œ0px 0px 0px 0pxâ€ ï¼Œå¦‚æœæœ‰æŒ‡å®š root å‚æ•°ï¼Œåˆ™ rootMargin ä¹Ÿå¯ä»¥ä½¿ç”¨ç™¾åˆ†æ¯”æ¥å–å€¼ã€‚
![rootMarginç¤ºæ„å›¾.jpg](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bb0d61f7c51443a28a4dbcbef127bc95~tplv-k3u1fbpfcp-zoom-1.image)
> å¦‚å›¾,è“è‰²çš„åŒºåŸŸå°±æ˜¯äº¤å‰åŒºåŸŸ, rootMargin å°±æ˜¯ç»™æ ¹å…ƒç´ æ‰©å¤§æˆ–ç¼©å°äº†åˆ¤æ–­çš„åŒºåŸŸ, å¦‚å›¾,å½“è§†å£(ç°è‰²åŒºåŸŸ)æ»‘åˆ°ä¸‹æ–¹è“è‰²è¾¹ç•Œçš„æ—¶å€™å°±æ¥è§¦åˆ°äº¤å‰åŒºåŸŸäº†,æ­¤æ—¶å°±ä¼šè§¦å‘ä¸€æ¬¡å›è°ƒå‡½æ•°äº†.æœ¬æ¥è¦æ¥è§¦åˆ°é»‘è‰²å°å—(targetç›®æ ‡)æ‰ä¼šç®—æ¥è§¦äº¤å‰åŒºåŸŸ,è§¦å‘å›è°ƒ.

- thresholdï¼š ä»‹äº 0 å’Œ 1 ä¹‹é—´çš„æ•°å­—ï¼ŒæŒ‡ç¤ºè§¦å‘å‰åº”å¯è§çš„ç™¾åˆ†æ¯”ã€‚ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ•°å­—æ•°ç»„ï¼Œä»¥åˆ›å»ºå¤šä¸ªè§¦å‘ç‚¹ï¼Œä¹Ÿè¢«ç§°ä¹‹ä¸º é˜ˆå€¼ã€‚å¦‚æœæ„é€ å™¨æœªä¼ å…¥å€¼, åˆ™é»˜è®¤å€¼ä¸º 0 ã€‚

![thresholdç¤ºæ„å›¾](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8629ab38882d44e8b6e6f7c894eafcb0~tplv-k3u1fbpfcp-zoom-1.image)

> å¯ä»¥ç†è§£ä¸ºåœ¨äº¤å‰åŒºåŸŸçš„è§¦å‘ç‚¹,æ¯”å¦‚threshold: [0.1, 0.2, 0.3, 0.5],å½“è§†å£è¿›å…¥äº¤å‰åŒºåŸŸçš„ç™¾åˆ†ä¹‹10,20â€¦ éƒ½ä¼šè§¦å‘å›è°ƒ(ä¾‹å¦‚çº¢è‰²æ¨ªçº¿)

- trackVisibilityï¼š ä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºå½“å‰è§‚å¯Ÿå™¨æ˜¯å¦å°†è·Ÿè¸ªç›®æ ‡å¯è§æ€§çš„æ›´æ”¹ï¼Œé»˜è®¤ä¸º false ï¼Œæ³¨æ„ï¼Œæ­¤å¤„çš„å¯è§æ€§å¹¶éæŒ‡ç›®æ ‡å…ƒç´ å’Œæ ¹å…ƒç´ æ˜¯å¦ç›¸äº¤ï¼Œè€Œæ˜¯æŒ‡**è§†å›¾ä¸Šæ˜¯å¦å¯è§ï¼ˆåœ¨è§†å£å†…ï¼‰**ï¼Œè¿™ä¸ªæˆ‘ä»¬ä¹‹å‰å°±å·²ç»åˆ†æè¿‡äº†ï¼Œå¦‚æœæ­¤å€¼è®¾ç½®ä¸º false æˆ–ä¸è®¾ç½®ï¼Œé‚£ä¹ˆå›è°ƒå‡½æ•°å‚æ•°ä¸­ IntersectionObserverEntry çš„ isVisible å±æ€§å°†æ°¸è¿œè¿”å› false ã€‚

- delayï¼š ä¸€ä¸ªæ•°å­—ï¼Œä¹Ÿå°±æ˜¯å›è°ƒå‡½æ•°æ‰§è¡Œçš„å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰ã€‚å¦‚æœ trackVisibility è®¾ç½®ä¸º trueï¼Œæ­¤å€¼æœ€å°å€¼è®¾ç½®ä¸º 100 ï¼Œå¦åˆ™ä¼šæŠ¥é”™ã€‚


### callbackï¼š å¯è§æ€§å‘ç”Ÿå˜åŒ–æ—¶è§¦å‘çš„å›è°ƒå‡½æ•°
å½“å…ƒç´ å¯è§æ¯”ä¾‹è¶…è¿‡æŒ‡å®šé˜ˆå€¼åï¼Œä¼šè°ƒç”¨ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ­¤å›è°ƒå‡½æ•°æ¥å—ä¸¤ä¸ªå‚æ•°ï¼šå­˜æ”¾ IntersectionObserverEntry å¯¹è±¡çš„æ•°ç»„å’Œè§‚å¯Ÿå™¨å®ä¾‹(å¯é€‰)

#### ç¬¬ä¸€ä¸ªå‚æ•°IntersectionObserverEntry

- boundingClientRectï¼š ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ç›®æ ‡å…ƒç´ çš„ getBoundingClientRect() æ–¹æ³•çš„è¿”å›å€¼ã€‚

- intersectionRatioï¼š ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ç›®æ ‡å…ƒç´ ä¸æ ¹å…ƒç´ äº¤å‰åŒºåŸŸ getBoundingClientRect() çš„è¿”å›å€¼ã€‚

- intersectionRectï¼š ç›®æ ‡å…ƒç´ çš„å¯è§æ¯”ä¾‹ï¼Œå³ intersectionRect å  boundingClientRect çš„æ¯”ä¾‹ï¼Œå®Œå…¨å¯è§æ—¶ä¸º 1 ï¼Œå®Œå…¨ä¸å¯è§æ—¶å°äºç­‰äº 0 ã€‚

- isIntersectingï¼š è¿”å›ä¸€ä¸ªå¸ƒå°”å€¼ï¼Œå¦‚æœç›®æ ‡å…ƒç´ ä¸æ ¹å…ƒç´ ç›¸äº¤ï¼Œåˆ™è¿”å› true ï¼Œå¦‚æœ isIntersecting æ˜¯ trueï¼Œåˆ™ target å…ƒç´ è‡³å°‘å·²ç»è¾¾åˆ° thresholds å±æ€§å€¼å½“ä¸­è§„å®šçš„å…¶ä¸­ä¸€ä¸ªé˜ˆå€¼ï¼Œå¦‚æœæ˜¯ falseï¼Œtarget å…ƒç´ ä¸åœ¨ç»™å®šçš„é˜ˆå€¼èŒƒå›´å†…å¯è§ã€‚

- isVisibleï¼š è¿™ä¸ªçœ‹å­—é¢æ„æ€åº”è¯¥æ˜¯ â€œæ˜¯å¦å¯è§â€ ï¼Œå¦‚æœè¦è®©è¿™ä¸ªå±æ€§ç”Ÿæ•ˆï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨æ„é€ å‡½æ•°ç”Ÿæˆè§‚å¯Ÿå™¨å®ä¾‹çš„æ—¶å€™ï¼Œä¼ å…¥çš„ options å‚æ•°å¿…é¡»é…ç½® trackVisibility ä¸º trueï¼Œå¹¶ä¸” delay è®¾ç½®ä¸ºå¤§äº 100 ï¼Œå¦åˆ™è¯¥å±æ€§å°†æ°¸è¿œè¿”å› false ã€‚
> è¡¨ç¤ºç›®æ ‡domæ˜¯å¦åœ¨è§†å£åŒºåŸŸ,ä¹Ÿå°±æ˜¯è¯´å½“å‰å¯ä¸å¯ä»¥çœ‹è§,èƒ½çœ‹è§å°±æ˜¯true,å³ä½¿ç›®æ ‡çš„é€æ˜åº¦ä¸º0 ä»ç„¶ä¸ºtrue.

- rootBoundsï¼š ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«æ ¹å…ƒç´ çš„ getBoundingClientRect() æ–¹æ³•çš„è¿”å›å€¼ã€‚

- targetï¼šï¼š è¢«è§‚å¯Ÿçš„ç›®æ ‡å…ƒç´ ï¼Œæ˜¯ä¸€ä¸ª DOM èŠ‚ç‚¹ã€‚åœ¨è§‚å¯Ÿè€…åŒ…å«å¤šä¸ªç›®æ ‡çš„æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ç¡®å®šå“ªä¸ªç›®æ ‡å…ƒç´ è§¦å‘äº†æ­¤ç›¸äº¤æ›´æ”¹çš„ç®€ä¾¿æ–¹æ³•ã€‚

- timeï¼š è¯¥å±æ€§æä¾›ä» é¦–æ¬¡åˆ›å»ºè§‚å¯Ÿè€… åˆ° è§¦å‘æ­¤äº¤é›†æ”¹å˜ çš„æ—¶é—´ï¼ˆä»¥æ¯«ç§’ä¸ºå•ä½ï¼‰ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œä½ å¯ä»¥è·Ÿè¸ªè§‚å¯Ÿå™¨è¾¾åˆ°ç‰¹å®šé˜ˆå€¼æ‰€èŠ±è´¹çš„æ—¶é—´ã€‚å³ä½¿ç¨åå°†ç›®æ ‡å†æ¬¡æ»šåŠ¨åˆ°è§†å›¾ä¸­ï¼Œæ­¤å±æ€§ä¹Ÿä¼šæä¾›æ–°çš„æ—¶é—´ã€‚è¿™å¯ç”¨äºè·Ÿè¸ªç›®æ ‡å…ƒç´ è¿›å…¥å’Œç¦»å¼€æ ¹å…ƒç´ çš„æ—¶é—´ï¼Œä»¥åŠä¸¤ä¸ªé˜ˆå€¼è§¦å‘çš„é—´éš”æ—¶é—´ã€‚


 boundingClientRect ï¼ŒintersectionRatio ï¼Œ rootBounds ä¸‰ä¸ªå±æ€§å±•å¼€çš„å†…å®¹
- bottomï¼š å…ƒç´ ä¸‹è¾¹è·ç¦»é¡µé¢ä¸Šè¾¹çš„è·ç¦»
- leftï¼š å…ƒç´ å·¦è¾¹è·ç¦»é¡µé¢å·¦è¾¹çš„è·ç¦»
- rightï¼š å…ƒç´ å³è¾¹è·ç¦»é¡µé¢å·¦è¾¹çš„è·ç¦»
- topï¼š å…ƒç´ ä¸Šè¾¹è·ç¦»é¡µé¢ä¸Šè¾¹çš„è·ç¦»
- widthï¼š å…ƒç´ çš„å®½
- heightï¼š å…ƒç´ çš„é«˜
- xï¼š ç­‰åŒäº leftï¼Œå…ƒç´ å·¦è¾¹è·ç¦»é¡µé¢å·¦è¾¹çš„è·ç¦»
- yï¼š ç­‰åŒäº topï¼Œå…ƒç´ ä¸Šè¾¹è·ç¦»é¡µé¢ä¸Šè¾¹çš„è·ç¦»

ç”¨ä¸€å¼ å›¾æ¥å±•ç¤ºä¸€ä¸‹è¿™å‡ ä¸ªå±æ€§ï¼Œç‰¹åˆ«éœ€è¦æ³¨æ„çš„æ˜¯ right å’Œ bottom ï¼Œè·Ÿæˆ‘ä»¬å¹³æ—¶å†™ css çš„ position é‚£ä¸ªä¸ä¸€æ ·

![top-bottom.png](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f9a189fb2ca44362beb2ce9b8bc93f92~tplv-k3u1fbpfcp-watermark.image?)

#### ç¬¬äºŒä¸ªå‚æ•°IntersectionObserver è§‚å¯Ÿå™¨å®ä¾‹å¯¹è±¡
è§‚å¯Ÿå™¨å®ä¾‹ä¸Šé¢åŒ…å«å¦‚ä¸‹å±æ€§

-   **root**
-   **rootMargin**
-   **thresholds**
-   **trackVisibility**
-   **delay**


æ˜¯ä¸æ˜¯ç‰¹åˆ«çœ¼ç†Ÿï¼Œæ²¡é”™ï¼Œå°±æ˜¯æˆ‘ä»¬åˆ›å»ºè§‚å¯Ÿè€…å®ä¾‹çš„æ—¶å€™ï¼Œä¼ å…¥çš„ `options` å¯¹è±¡ï¼Œåªä¸è¿‡ `options` å¯¹è±¡æ˜¯å¯é€‰çš„ï¼Œè§‚å¯Ÿå™¨å®ä¾‹çš„å±æ€§å°±ä½¿ç”¨æˆ‘ä»¬ä¼ å…¥çš„ `options` å¯¹è±¡ï¼Œå¦‚æœæ²¡ä¼ å°±ä½¿ç”¨é»˜è®¤å€¼ï¼Œå”¯ä¸€ä¸åŒçš„æ˜¯ï¼Œ`options` ä¸­ çš„å±æ€§ `threshold` æ˜¯å•æ•°ï¼Œè€Œæˆ‘ä»¬å®ä¾‹è·å–åˆ°çš„ `thresholds` æ˜¯å¤æ•°

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„æ‰€æœ‰å±æ€§éƒ½æ˜¯ **åªè¯»** çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€æ—¦è§‚å¯Ÿå™¨è¢«åˆ›å»ºï¼Œåˆ™ **æ— æ³•** æ›´æ”¹å…¶é…ç½®ï¼Œæ‰€ä»¥ä¸€ä¸ªç»™å®šçš„è§‚å¯Ÿè€…å¯¹è±¡åªèƒ½ç”¨æ¥ç›‘å¬å¯è§åŒºåŸŸçš„ç‰¹å®šå˜åŒ–å€¼ã€‚

### ç®€æ˜“demo
å¯ä»¥è‡ªå·±è°ƒè¯•ç©
```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    .root {
      height: 400px;
      width: 400px;
      border: 1px solid black;
      overflow-y: scroll;
    }
    .root .box {
      position: relative;
      width: 400px;
      height: 900px;
    }
    .root .box .target{
      /* opacity: 0; */
      position: absolute;
      bottom: 0;
      width: 50px;
      height: 50px;
      background-color: aqua;
    }
  </style>
</head>
<body>
  <div class="root">
    <div class="box">
      <div class="target"></div>
      <div ></div>
    </div>
  </div>
  <script>
    ((doc) => {
      let n = 0
      //è·å–ç›®æ ‡å…ƒç´ 
      const target = doc.querySelector(".target")
      //è·å–æ ¹å…ƒç´ 
      const root = doc.querySelector(".root")
      //å›è°ƒå‡½æ•°
      const callback = (entries, observer) => {
        n++
        console.log(`ğŸ´ğŸ´~ æ‰§è¡Œäº† ${n} æ¬¡callback`);
        console.log('ğŸ´ğŸ´~ entries:', entries);
        console.log('ğŸ´ğŸ´~ observer:', observer);
      };
      //é…ç½®å¯¹è±¡
      const options = {
        root: root,
        rootMargin: '0px 0px 100px 0px',
        threshold: [0.1, 0.3, 0.5, 0.8, 1],
        trackVisibility: true,
        delay: 100
      };
      //åˆ›å»ºè§‚å¯Ÿå™¨
      const myObserver = new IntersectionObserver(callback, options);
      //å¼€å§‹ç›‘å¬ç›®æ ‡å…ƒç´ 
      myObserver.observe(target);
      console.log('ğŸ´ğŸ´~ myObserver:', myObserver);
    })(document)
  </script>
</body>
</html>
```

### è§‚å¯Ÿå™¨å®ä¾‹æ–¹æ³•
1. observe

```
 const myObserver = new IntersectionObserver(callback, options);
 myObserver.observe(target);
```

æ¥å—ä¸€ä¸ªç›®æ ‡å…ƒç´ ä½œä¸ºå‚æ•°ã€‚å¾ˆå¥½ç†è§£ï¼Œå½“æˆ‘ä»¬åˆ›å»ºå®Œè§‚å¯Ÿå™¨å®ä¾‹åï¼Œè¦æ‰‹åŠ¨çš„è°ƒç”¨ `observe` æ–¹æ³•æ¥é€šçŸ¥å®ƒå¼€å§‹ç›‘æµ‹ç›®æ ‡å…ƒç´ ã€‚

**å¯ä»¥åœ¨åŒä¸€ä¸ªè§‚å¯Ÿè€…å¯¹è±¡ä¸­é…ç½®ç›‘å¬å¤šä¸ªç›®æ ‡å…ƒç´ **

`target2` å…ƒç´ æ˜¯é€šè¿‡ä»£ç è‡ªåŠ¨ç›‘æµ‹çš„ï¼Œè€Œ `target1` åˆ™æ˜¯æˆ‘ä»¬åœ¨ç‚¹å‡»äº† `observe` æŒ‰é’®ä¹‹åå¼€å§‹ç›‘æµ‹çš„ã€‚é€šè¿‡åŠ¨å›¾å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘å•å‡» `observe` æŒ‰é’®åï¼Œæˆ‘ä»¬çš„ `entries` æ•°ç»„é‡Œé¢å°±åŒ…å«äº†ä¸¤æ¡æ•°æ®ï¼Œå‰æ–‡ä¸­è¯´åˆ°ï¼Œå¯ä»¥é€šè¿‡ `target` å±æ€§æ¥åˆ¤æ–­æ˜¯å“ªä¸ªç›®æ ‡å…ƒç´ 

2. unobserve

```
 const myObserver = new IntersectionObserver(callback, options);
 myObserver.observe(target);
 myObserver.unobserve(target)
```

æ¥æ”¶ä¸€ä¸ªç›®æ ‡å…ƒç´ ä½œä¸ºå‚æ•°ï¼Œå½“æˆ‘ä»¬ä¸æƒ³ç›‘å¬æŸä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨è°ƒç”¨ `unobserve` æ–¹æ³•æ¥åœæ­¢ç›‘å¬æŒ‡å®šç›®æ ‡å…ƒç´ ã€‚é€šè¿‡åŠ¨å›¾å¯ä»¥å‘ç°ï¼Œå½“æˆ‘ä»¬ç‚¹å‡» `unobserve` æŒ‰é’®åï¼Œç”±ä¸¤æ¡æ•°æ®å˜æˆäº†ä¸€æ¡æ•°æ®ï¼Œè¯´æ˜ `target1` å·²ç»ä¸å†æ¥å—ç›‘æµ‹äº†ã€‚

3. disconnect

```
 const myObserver = new IntersectionObserver(callback, options);
 myObserver.disconnect()
```

å½“æˆ‘ä»¬ä¸æƒ³ç›‘æµ‹ä»»ä½•ä¸€ä¸ªç›®æ ‡å…ƒç´ æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `disconnect` æ–¹æ³•åœæ­¢ç›‘å¬å·¥ä½œã€‚é€šè¿‡åŠ¨å›¾å¯ä»¥çœ‹åˆ°ï¼Œå½“æˆ‘ä»¬ç‚¹å‡» `disconnect` æŒ‰é’®åï¼Œæ§åˆ¶å°ä¸å†è¾“å‡º `log` ï¼Œè¯´æ˜ç›‘å¬å·¥ä½œå·²ç»åœæ­¢ï¼Œå¯ä»¥é€šè¿‡ `observe` å†æ¬¡å¼€å¯ç›‘å¬å·¥ä½œã€‚

4. takeRecords

è¿”å›æ‰€æœ‰è§‚å¯Ÿç›®æ ‡çš„ `IntersectionObserverEntry` å¯¹è±¡æ•°ç»„ï¼Œåº”ç”¨åœºæ™¯è¾ƒå°‘ã€‚

å½“è§‚å¯Ÿåˆ°äº¤äº’åŠ¨ä½œå‘ç”Ÿæ—¶ï¼Œå›è°ƒå‡½æ•°å¹¶ä¸ä¼šç«‹å³æ‰§è¡Œï¼Œè€Œæ˜¯åœ¨ç©ºé—²æ—¶æœŸä½¿ç”¨ `requestIdleCallback` æ¥å¼‚æ­¥æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œä½†æ˜¯ä¹Ÿæä¾›äº†åŒæ­¥è°ƒç”¨çš„ `takeRecords` æ–¹æ³•ã€‚

å¦‚æœå¼‚æ­¥çš„å›è°ƒå…ˆæ‰§è¡Œäº†ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬è°ƒç”¨åŒæ­¥çš„ `takeRecords` æ–¹æ³•æ—¶ä¼šè¿”å›ç©ºæ•°ç»„ã€‚åŒç†ï¼Œå¦‚æœå·²ç»é€šè¿‡ `takeRecords` è·å–äº†æ‰€æœ‰çš„è§‚å¯Ÿè€…å®ä¾‹ï¼Œé‚£ä¹ˆå›è°ƒå‡½æ•°å°±ä¸ä¼šè¢«æ‰§è¡Œäº†ã€‚

# å…¶ä»–æ³¨æ„ç‚¹
## æ„é€ å‡½æ•° IntersectionObserver é…ç½®çš„å›è°ƒå‡½æ•°éƒ½åœ¨å“ªäº›æƒ…å†µä¸‹è¢«è°ƒç”¨?

æ„é€ å‡½æ•° `IntersectionObserver` é…ç½®çš„å›è°ƒå‡½æ•°ï¼Œåœ¨ä»¥ä¸‹æƒ…å†µå‘ç”Ÿæ—¶å¯èƒ½ä¼šè¢«è°ƒç”¨
-   `Observer` ç¬¬ä¸€æ¬¡ç›‘å¬ç›®æ ‡å…ƒç´ çš„æ—¶å€™ã€‚
-   å½“ç›®æ ‡ï¼ˆ**target**ï¼‰å…ƒç´ ä¸æ ¹ï¼ˆ**root**ï¼‰å…ƒç´ å‘ç”Ÿäº¤é›†çš„æ—¶å€™æ‰§è¡Œã€‚
-   ä¸¤ä¸ªå…ƒç´ çš„ç›¸äº¤éƒ¨åˆ†å¤§å°å‘ç”Ÿå˜åŒ–æ—¶ã€‚
æ— è®ºç›®æ ‡å…ƒç´ æ˜¯å¦ä¸æ ¹å…ƒç´ ç›¸äº¤ï¼Œå½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡ç›‘å¬ç›®æ ‡å…ƒç´ çš„æ—¶å€™ï¼Œå›è°ƒå‡½æ•°éƒ½ä¼šè§¦å‘ä¸€æ¬¡ï¼Œæ‰€ä»¥ä¸è¦ç›´æ¥åœ¨å›è°ƒå‡½æ•°é‡Œå†™é€»è¾‘ä»£ç ï¼Œå°½é‡é€šè¿‡ `isIntersecting` æˆ–è€… `intersectionRect` è¿›è¡Œåˆ¤æ–­ä¹‹åå†æ‰§è¡Œé€»è¾‘ä»£ç 

## é¡µé¢çš„å¯è§æ€§å¦‚ä½•ç›‘æµ‹

é¡µé¢çš„å¯è§æ€§å¯ä»¥é€šè¿‡`document.visibilityState`æˆ–è€…`document.hidden`è·å¾—ã€‚é¡µé¢å¯è§æ€§çš„å˜åŒ–å¯ä»¥é€šè¿‡`document.visibilitychange`æ¥ç›‘å¬ã€‚

## å¯è§æ€§å’Œäº¤å‰è§‚å¯Ÿ

å½“ `css` è®¾ç½®äº†`opacity: 0`ï¼Œ`visibility: hidden` ä»¥åŠ `ç”¨å…¶ä»–çš„å…ƒç´ è¦†ç›–ç›®æ ‡å…ƒç´ ` ï¼Œéƒ½ä¸ä¼šå½±å“äº¤å‰è§‚å¯Ÿå™¨çš„ç›‘æµ‹ï¼Œä¹Ÿå°±æ˜¯éƒ½ä¸ä¼šå½±å“ `isIntersecting` å±æ€§çš„ç»“æœï¼Œä½†æ˜¯ä¼šå½±å“ `isVisible` å±æ€§çš„ç»“æœï¼Œ å¦‚æœå…ƒç´ è®¾ç½®äº† `displayï¼šnone` å°±ä¸ä¼šè¢«æ£€æµ‹äº†ã€‚å½“ç„¶å½±å“å…ƒç´ å¯è§†æ€§çš„å±æ€§ä¸æ­¢ä¸Šè¿°è¿™äº›ï¼Œè¿˜åŒ…æ‹¬`position`ï¼Œ`margin`ï¼Œ`clip` ç­‰ç­‰ç­‰ç­‰..

## äº¤é›†çš„è®¡ç®—

æ‰€æœ‰åŒºåŸŸå‡è¢« `Intersection Observer API` å½“åšä¸€ä¸ª **çŸ©å½¢** çœ‹å¾…ã€‚å¦‚æœå…ƒç´ æ˜¯ä¸è§„åˆ™çš„å›¾å½¢ä¹Ÿå°†ä¼šè¢«çœ‹æˆä¸€ä¸ªåŒ…å«å…ƒç´ æ‰€æœ‰åŒºåŸŸçš„æœ€å°çŸ©å½¢ï¼Œç›¸ä¼¼çš„ï¼Œå¦‚æœå…ƒç´ å‘ç”Ÿçš„äº¤é›†éƒ¨åˆ†ä¸æ˜¯ä¸€ä¸ªçŸ©å½¢ï¼Œé‚£ä¹ˆä¹Ÿä¼šè¢«çœ‹ä½œæ˜¯ä¸€ä¸ªåŒ…å«ä»–æ‰€æœ‰äº¤é›†åŒºåŸŸçš„æœ€å°çŸ©å½¢ã€‚

## æˆ‘æ€ä¹ˆçŸ¥é“ç›®æ ‡å…ƒç´ æ¥è‡ªè§†å£çš„ä¸Šæ–¹è¿˜æ˜¯ä¸‹æ–¹

ç›®æ ‡å…ƒç´ æ»šåŠ¨çš„æ–¹å‘ä¹Ÿæ˜¯å¯ä»¥åˆ¤æ–­çš„ï¼ŒåŸç†æ˜¯æ ¹å…ƒç´ çš„ `entry.rootBounds.y` (æ ¹å®¹å™¨top)æ˜¯å›ºå®šä¸å˜çš„ ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¡ç®— `entry.boundingClientRect.y`ï¼ˆç›®æ ‡å…ƒç´ çš„topï¼‰ ä¸ `entry.rootBounds.y` çš„å¤§å°ï¼Œå½“å›è°ƒå‡½æ•°è§¦å‘çš„æ—¶å€™ï¼Œæˆ‘ä»¬è®°å½•ä¸‹å½“æ—¶çš„ä½ç½®ï¼Œå¦‚æœ `entry.boundingClientRect.y > entry.rootBounds.y`ï¼Œè¯´æ˜æ˜¯åœ¨è§†å£ä¸‹æ–¹ï¼Œé‚£ä¹ˆå½“ä¸‹ä¸€æ¬¡ç›®æ ‡å…ƒç´ å¯è§çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±çŸ¥é“ç›®æ ‡å…ƒç´ æ—¶æ¥è‡ªè§†å£ä¸‹æ–¹çš„ï¼Œåä¹‹äº¦ç„¶ã€‚

```
let wasAbove = false;
function callback(entries, observer) {
    entries.forEach(entry => {
        const isAbove = entry.boundingClientRect.y > entry.rootBounds.y;\\
        if (entry.isIntersecting) {
            if (wasAbove) {
                // Comes from top
            }
        }
        wasAbove = isAbove;
    });
}
```
# åº”ç”¨åœºæ™¯

## 1æ— é™æ»šåŠ¨
(è¯¥ä¾‹å­ä¸­ï¼Œå¦‚æœå¿«é€Ÿæ»‘åŠ¨é¡µé¢ï¼Œé¡µé¢ä¼šæœ‰ä¸€ç§å¡ä½çš„æ„Ÿè§‰ï¼Œå†æ¬¡å¾€ä¸‹æ»‘å°†æ— æ³•è§¦å‘æ— é™æ»šåŠ¨ï¼Œå®é™…ä¸Šè¿™æ˜¯å› ä¸ºæˆ‘ä»¬è®¾ç½®äº†å»¶è¿Ÿæ—¶é—´çš„ç¼˜æ•…ï¼Œåªè¦æˆ‘ä»¬æŠŠtrackVisibilityè®¾ä¸ºfalseï¼Œæ¸…ç©ºdelayå³å¯ã€‚ä½†æ˜¯è¿™æ ·åœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ä¼šæœ‰æ€§èƒ½é—®é¢˜ï¼Œå› ä¸ºå¦‚æœç”¨æˆ·ä¸åœçš„å¿«é€Ÿå¾€ä¸‹åˆ·ï¼Œå°±ä¼šä¸æ–­çš„è¯·æ±‚ï¼Œæ‰€ä»¥è¿˜è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡ŒèŠ‚æµ)
```
<template>
  <div>
    <div class="box">
      <div class="vbody"
           v-for='item in list'
           :key='item'>å†…å®¹åŒºåŸŸ{{item}}</div>
      <div class="reference"
           ref='reference'></div>
    </div>
  </div>
</template>

<script>
export default {
  name: '',
  data () {
    return {
      list: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
    }
  },
  methods: {
    intersectionObserver () {
      let n = 10
      const reference = this.$refs.reference
      // å›è°ƒå‡½æ•°
      const callback = (entries) => {
        console.log(entries)
        const myEntry = entries[0]
        if (myEntry.isIntersecting) {
          console.log(`ğŸš€ğŸš€~ è§¦å‘äº†æ— çº¿æ»šåŠ¨,å¼€å§‹æ¨¡æ‹Ÿè¯·æ±‚æ•°æ® ${n}`)
          n++
          this.list.push(n)
        }
      }
      // é…ç½®å¯¹è±¡
      const options = {
        root: null,
        rootMargin: '0px 100px 0px 0px',
        threshold: [0, 1],
        trackVisibility: true,
        delay: 100
      }
      // è§‚å¯Ÿå™¨å®ä¾‹
      const myObserver = new IntersectionObserver(callback, options)
      // å¼€å§‹è§‚å¯Ÿ
      myObserver.observe(reference)
    }
  },
  mounted () {
    this.intersectionObserver()
  }
}
</script>

<style scoped lang="less">
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}
.reference {
  width: 100%;
  visibility: hidden;
}
.vbody {
  width: 100%;
  height: 200px;
  // background-color: red;
  border: 2px solid darkblue;
  color: black;
  font-size: 40px;
  text-align: center;
  line-height: 200px;
  margin: 10px 0;
}
</style>
```
## 2å›¾ç‰‡é¢„åŠ è½½
åˆ©ç”¨ `options` çš„ `rootMargin`å±æ€§ï¼Œå¯ä»¥åœ¨å›¾ç‰‡å³å°†è¿›å…¥å¯è§†åŒºåŸŸçš„æ—¶é—´è¿›è¡Œå›¾ç‰‡çš„åŠ è½½ï¼Œå³é¿å…äº†æå‰è¯·æ±‚å¤§é‡å›¾ç‰‡é€ æˆçš„æ€§èƒ½é—®é¢˜ï¼Œä¹Ÿé¿å…äº†å›¾ç‰‡è¿›å…¥çª—å£æ‰åŠ è½½å·²ç»æ¥ä¸åŠçš„é—®é¢˜

## 3åŸ‹ç‚¹ä¸ŠæŠ¥
é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç»Ÿè®¡ä¸€ä¸ªå…ƒç´ æ˜¯å¦è¢«ç”¨æˆ·æœ‰æ•ˆçš„çœ‹åˆ°ï¼Œå¹¶ä¸æ˜¯å…ƒç´ åˆšå‡ºç°å°±è§¦å‘åŸ‹ç‚¹ï¼Œè€Œæ˜¯å…ƒç´ è¿›å…¥å¯æ˜¯åŒºåŸŸä¸€å®šæ¯”ä¾‹æ‰å¯ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½® `options` çš„ `threshold` ä¸º `0.5`ã€‚

*æ¡ˆä¾‹ä»£ç å·®åˆ«ä¸å¤§ï¼ŒåŸç†ç›¸åŒï¼Œæš‚æ—¶ä¸è´´äº†ï¼Œæœ‰éœ€è¦å¯ä»¥å†å‘ã€‚*
# å…¼å®¹æ€§

![image.png](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e34d94805d2443f39c42d5f4a58d9a50~tplv-k3u1fbpfcp-watermark.image?)


![image.png](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/2825f6d030db48979d3b89c63a5eda18~tplv-k3u1fbpfcp-watermark.image?)
ä¸ºä»€ä¹ˆæœ‰ä¸¤å¼ å…¼å®¹æ€§çš„å›¾å‘¢ï¼Ÿå› ä¸º **trackVisibility** å’Œ **delay** ä¸¤ä¸ªå±æ€§æ˜¯å±äº `IntersectionObserver V2` çš„ã€‚æ‰€ä»¥å°ä¼™ä¼´ä»¬åœ¨ç”¨çš„æ—¶å€™ä¸€å®šè¦æ³¨æ„å…¼å®¹æ€§ã€‚å½“ç„¶ä¹Ÿæœ‰å…¼å®¹è§£å†³æ–¹æ¡ˆï¼Œé‚£å°±æ˜¯ `intersection-observer-polyfill`

